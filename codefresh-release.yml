version: '1.0'

#TODO in case of a prelease make sure to create a prelease in github and in npm
steps:

#create a prelease in case of not executing from master
  build_executables:
    title: "Compiling executables"
    image: node:9.2.0
    commands:
      - "yarn install"
      - "apt-get update"
      - "apt-get install -y zip jq"
      - 'PACKAGE_VERSION=$(jq -r ".name" package.json)'
      - "Current version: $PACKAGE_VERSION"
      - "cf_export PACKAGE_VERSION"
      - 'curl -X POST -d "{"tag_name":"$PACKAGE_VERSION","target_commitish":"${{CF_REVISION}}","name":"Codefresh V$PACKAGE_VERSION"}" -H "Content-Type: application/json" -H "Authorization: token ${{TOKEN}}" https://uploads.github.com/repos/codefresh-io/codefresh/releases/'
      - "yarn pkg"
      - "cd dist"
      - "tar -cf codefresh-${{CF_BRANCH}}-linux-x64.tar codefresh-linux-x64 ../README.md ../LICENSE"
      - "gzip codefresh-${{CF_BRANCH}}-linux-x64.tar"
      - "curl https://api.github.com/repos/codefresh-io/codefresh/releases/tags/${{CF_BRANCH}} | jq -r '.id' > release-id.txt"
      - 'curl -X POST -H "Content-Type:application/octet-stream" -H "Authorization: token ${{TOKEN}}"  --data-binary @codefresh-${{CF_BRANCH}}-linux-x64.tar.gz https://uploads.github.com/repos/codefresh-io/codefresh/releases/$(cat release-id.txt)/assets?name=codefresh-${{CF_BRANCH}}-linux-x64.tar.gz'

  push_to_registry_latest:
    title: "Update dockerhub image latest tag"
    type: push
    candidate: r.cfcr.io/codefresh-inc/codefresh/cli:${{CF_SHORT_REVISION}}
    image_name: codefresh/cli
    tag: ${{PACKAGE_VERSION}}
    registry: dockerhub

  push_to_registry_version:
    title: "Update dockerhub image latest tag"
    type: push
    candidate: r.cfcr.io/codefresh-inc/codefresh/cli:${{CF_SHORT_REVISION}}
    tag: latest
    registry: dockerhub
    when:
      branch:
        only: [ master ]

  deploy_to_npm:
    title: Publishing To Npm
    image: codefresh/npm-publish:master
    commands:
      - NPM_TOKEN=${{NPM_TOKEN}} npm run ci-publish
    when:
      branch:
        only: [ master ]
